@page
@model DmsProjeckt.Pages.Dokument.SuchenModel
@{
    ViewData["Title"] = "Dokumentensuche";
}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />

<style>
    /* Modern Page Container */
    .modern-search-wrapper {
        background: white;
        border-radius: 1.1rem;
        box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        padding: 2.5rem 2rem;
        margin: 2rem 0;
    }

    /* Modern Header */
    .search-header {
        text-align: center;
        margin-bottom: 3rem;
        padding-bottom: 2rem;
        border-bottom: 1px solid #f0f0f0;
    }

    .search-header h2 {
        color: #000;
        font-size: 2rem;
        margin-bottom: 0.5rem;
        font-weight: 600;
    }

    .search-header p {
        color: #666;
        font-size: 1rem;
        margin: 0;
    }

    /* Mode Toggle Buttons */
    .mode-toggle {
        display: flex;
        gap: 1rem;
        justify-content: center;
        margin-bottom: 2rem;
    }

    .mode-toggle .btn {
        background: #f5f5f5;
        color: #666;
        border: 2px solid transparent;
        border-radius: 0.6rem;
        padding: 0.7rem 2rem;
        font-weight: 600;
        transition: all 0.2s;
        min-width: 200px;
    }

    .mode-toggle .btn:hover {
        background: #e8e8e8;
        color: #000;
    }

    .mode-toggle .btn.active {
        background: #000;
        color: white;
        border: 2px solid #000;
    }

    /* Search Section */
    .search-section {
        background: #fafafa;
        border-radius: 0.8rem;
        padding: 2rem;
        margin-bottom: 2rem;
        border: 1px solid #e0e0e0;
    }

    .search-section h3 {
        color: #000;
        font-size: 1.2rem;
        font-weight: 600;
        margin-bottom: 1rem;
    }

    .search-section .subtitle {
        color: #666;
        font-size: 0.95rem;
        margin-bottom: 1.5rem;
    }

    /* Modern Search Input */
    .modern-searchbar {
        background: white;
        border: 2px solid #e0e0e0;
        color: #000;
        font-size: 1.1rem;
        border-radius: 0.6rem;
        padding: 1rem 1.2rem;
        transition: all 0.2s;
    }

    .modern-searchbar:focus {
        border-color: #000;
        background: white;
        color: #000;
        outline: none;
        box-shadow: 0 0 0 3px rgba(0,0,0,0.1);
    }

    /* Form Labels */
    label, .form-label {
        color: #000;
        font-weight: 600;
        margin-bottom: 0.5rem;
        font-size: 0.95rem;
    }

    /* Modern Table */
    .results-table-wrapper {
        border-radius: 0.8rem;
        border: 1px solid #e0e0e0;
        overflow: hidden;
        margin-top: 2rem;
    }

    .modern-table {
        width: 100%;
        border-collapse: collapse;
        background: white;
        margin: 0;
    }

    .modern-table thead {
        background: #f5f5f5;
    }

    .modern-table thead th {
        padding: 1rem 1.2rem;
        text-align: left;
        font-weight: 600;
        color: #000;
        font-size: 0.95rem;
        border-bottom: 2px solid #e0e0e0;
    }

    .modern-table tbody td {
        padding: 1rem 1.2rem;
        color: #333;
        border-bottom: 1px solid #f0f0f0;
        vertical-align: middle;
    }

    .modern-table tbody tr:last-child td {
        border-bottom: none;
    }

    .modern-table tbody tr:hover {
        background: #fafafa;
    }

    /* Modern Button */
    .modern-btn {
        background: #000;
        color: white;
        padding: 0.6rem 1.5rem;
        border-radius: 0.5rem;
        border: none;
        font-weight: 600;
        transition: all 0.2s;
        cursor: pointer;
    }

    .modern-btn:hover {
        background: #333;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }

    .modern-btn-small {
        padding: 0.4rem 0.8rem;
        font-size: 0.9rem;
    }

    /* History Panel - Modernized */
    #searchHistoryPanel {
        position: fixed;
        top: 0;
        right: 0;
        width: 500px;
        height: 100vh;
        background: white;
        border-left: 1px solid #e0e0e0;
        box-shadow: -4px 0 20px rgba(0,0,0,0.1);
        padding: 2rem;
        z-index: 2500;
        display: flex;
        flex-direction: column;
        transition: right 0.3s ease, opacity 0.2s;
        opacity: 1;
    }

    #searchHistoryPanel.collapsed {
        right: -550px;
        opacity: 0;
        pointer-events: none;
    }

    #searchHistoryPanel h3 {
        color: #000;
        font-size: 1.5rem;
        font-weight: 600;
        margin-bottom: 1.5rem;
    }

    /* History Toggle Button */
    #toggleHistoryBtn {
        position: fixed;
        top: 25px;
        right: 30px;
        z-index: 2550;
        background: #000;
        color: white;
        border: none;
        padding: 0.7rem 1.5rem;
        border-radius: 0.5rem;
        font-weight: 600;
        box-shadow: 0 2px 12px rgba(0,0,0,0.15);
        transition: all 0.2s;
    }

    #toggleHistoryBtn:hover {
        background: #333;
        transform: translateY(-1px);
    }

    /* History Filters */
    #historyFilters .btn {
        background: #f5f5f5;
        color: #666;
        border: none;
        padding: 0.5rem 1rem;
        font-size: 0.9rem;
        border-radius: 0.4rem;
        margin-right: 0.5rem;
        transition: all 0.2s;
    }

    #historyFilters .btn:hover {
        background: #e8e8e8;
        color: #000;
    }

    #historyFilters .btn.active {
        background: #000;
        color: white;
    }

    /* History List */
    #historyTable {
        font-size: 0.9rem;
    }

    #historyTable thead {
        background: #f5f5f5;
    }

    #historyTable thead th {
        padding: 0.8rem;
        font-weight: 600;
        color: #000;
        border-bottom: 2px solid #e0e0e0;
    }

    #historyTable tbody tr {
        cursor: pointer;
        transition: background 0.2s;
    }

    #historyTable tbody tr:hover {
        background: #fafafa;
    }

    #historyTable tbody td {
        padding: 0.8rem;
        border-bottom: 1px solid #f0f0f0;
    }

    /* Loader */
    #loader {
        text-align: center;
        padding: 1rem;
        color: #666;
    }

    /* Autocomplete */
    .awesomplete {
        position: relative;
        z-index: 9999;
    }

    .awesomplete > ul {
        position: absolute;
        z-index: 9999;
        background: white;
        color: #000;
        border: 1px solid #e0e0e0;
        border-radius: 0.6rem;
        box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        margin-top: 0.25rem;
        list-style: none;
        padding: 0.5rem 0;
    }

    .awesomplete > ul > li {
        padding: 0.75rem 1rem;
        cursor: pointer;
        color: #333;
        transition: all 0.15s;
    }

    .awesomplete > ul > li:hover,
    .awesomplete > ul > li[aria-selected="true"] {
        background: #000;
        color: white;
        font-weight: 600;
    }

    /* Modal Styling */
    .modern-modal .modal-content {
        background: white;
        border-radius: 1rem;
        border: 1px solid #e0e0e0;
        box-shadow: 0 8px 32px rgba(0,0,0,0.15);
    }

    .modern-modal .modal-header {
        border-bottom: 1px solid #f0f0f0;
        padding: 1.5rem;
    }

    .modern-modal .modal-title {
        color: #000;
        font-weight: 600;
    }

    .modern-modal .modal-body {
        padding: 1.5rem;
    }

    .modern-modal .form-control {
        background: white;
        border: 1px solid #e0e0e0;
        color: #000;
        border-radius: 0.5rem;
        padding: 0.6rem 1rem;
    }

    .modern-modal .form-control:focus {
        border-color: #000;
        box-shadow: 0 0 0 3px rgba(0,0,0,0.1);
    }

    /* Action Buttons in Table */
    .action-btn {
        background: transparent;
        border: 1px solid #e0e0e0;
        color: #666;
        padding: 0.4rem 0.6rem;
        border-radius: 0.4rem;
        transition: all 0.2s;
        margin-right: 0.3rem;
    }

    .action-btn:hover {
        background: #000;
        color: white;
        border-color: #000;
    }

    /* Dropdown Menu */
    .dropdown-menu {
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 0.5rem;
        box-shadow: 0 2px 12px rgba(0,0,0,0.1);
        z-index: 3000;
    }

    .dropdown-item {
        color: #333;
        padding: 0.6rem 1rem;
    }

    .dropdown-item:hover {
        background: #f5f5f5;
        color: #000;
    }

    /* 🔄 Spinner Overlay */
    .spinner-overlay {
        position: absolute;
        top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(255, 255, 255, 0.9);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 2000;
        backdrop-filter: blur(2px);
    }
    .spinner-border-lg {
        width: 3rem; height: 3rem; border-width: 0.25em;
    }
   
</style>

<div class="modern-search-wrapper">
    <!-- Modern Header -->
    <div class="search-header">
        <h2>🔍 Dokumentensuche</h2>
        <p>Finde deine Dokumente schnell und einfach</p>
    </div>

    <!-- Mode Toggle -->
    <div class="mode-toggle">
        <button type="button" class="btn active" id="btnIntelligent" onclick="zeigeSuche('intelligent')">
            ✨ Intelligente Suche
        </button>
        <button type="button" class="btn" id="btnIndex" onclick="zeigeSuche('index')">
            📋 Metadaten-Suche
        </button>
    </div>

    <input type="hidden" id="currentSearchMode" name="CurrentSearchMode" value="@Model.CurrentSearchMode" />

    <!-- Intelligent Search Section -->
    <div id="intelligent" class="search-section" style="display:block;">
        <h3>🔍 Intelligente Suche</h3>
        <div class="subtitle">
            Gib einen Begriff ein – Vorschläge erscheinen automatisch (Dateiname, Kategorie, OCR-Text, UID...)
        </div>
        <input id="liveSearch" class="form-control modern-searchbar" 
               placeholder="Suchbegriff eingeben..." autocomplete="off" />
        <div id="loader" style="display:none;">
            <div class="spinner-border" style="color:#000;"></div> Suche läuft…
        </div>
    </div>

    <!-- Metadata Search Section -->
    <div id="index" class="search-section" style="display:none;">
        <form method="get" autocomplete="off">
            <input type="hidden" name="CurrentSearchMode" id="indexModeField" value="index" />
            <h3>📋 Metadaten durchsuchen</h3>
            <div class="row g-3 mb-3">
                <div class="col-md-3">
                    <label for="metaDateiname">Dateiname</label>
                    <input id="metaDateiname" type="text" name="Filter.Dateiname" 
                           class="form-control modern-searchbar" placeholder="Dateiname..." 
                           value="@Model.Filter.Dateiname" />
                </div>
                <div class="col-md-3">
                    <label for="metaRechnungsnummer">Rechnungsnummer</label>
                    <input id="metaRechnungsnummer" type="text" name="Filter.Rechnungsnummer" 
                           class="form-control modern-searchbar" placeholder="Rechnungsnummer..." 
                           value="@Model.Filter.Rechnungsnummer" />
                </div>
                <div class="col-md-3">
                    <label for="metaUIDNummer">UID Nummer</label>
                    <input id="metaUIDNummer" type="text" name="Filter.UIDNummer" 
                           class="form-control modern-searchbar" placeholder="UID Nummer..." 
                           value="@Model.Filter.UIDNummer" />
                </div>
                <div class="col-md-3">
                    <label for="metaOCRText">OCR Text</label>
                    <input id="metaOCRText" type="text" name="Filter.OCRText" 
                           class="form-control modern-searchbar" placeholder="OCR Text..." 
                           value="@Model.Filter.OCRText" />
                </div>
            </div>
            <div class="row g-3 mb-3">
                <div class="col-md-4">
                    <label for="metaKundennummer">Kundennummer</label>
                    <input id="metaKundennummer" type="text" name="Filter.Kundennummer" 
                           class="form-control modern-searchbar" placeholder="Kundennummer..." 
                           value="@Model.Filter.Kundennummer" />
                </div>
                <div class="col-md-4">
                    <label for="metaKategorie">Kategorie</label>
                    <input id="metaKategorie" type="text" name="Filter.Kategorie" 
                           class="form-control modern-searchbar" placeholder="Kategorie..." 
                           value="@Model.Filter.Kategorie" />
                </div>
                <div class="col-md-4">
                    <label for="metaBeschreibung">Beschreibung</label>
                    <input id="metaBeschreibung" type="text" name="Filter.Beschreibung" 
                           class="form-control modern-searchbar" placeholder="Beschreibung..." 
                           value="@Model.Filter.Beschreibung" />
                </div>
            </div>
            <button class="modern-btn" type="submit">🔎 Suchen</button>
        </form>
    </div>

    <!-- Results Table -->
    <div class="results-table-wrapper">
        <table class="modern-table">
            <thead>
                <tr>
                    <th>Dateiname</th>
                    <th>Datum</th>
                    <th>Kategorie</th>
                    <th style="text-align:right;">Aktionen</th>
                </tr>
            </thead>
            <tbody id="resultBody">
                @foreach (var d in Model.Results)
                {
                    <tr>
                        <td><strong>@d.Dateiname</strong></td>
                        <td>@d.HochgeladenAm.ToString("g")</td>
                        <td>@d.Kategorie</td>
                        <td style="text-align:right;">
                            <button class="action-btn" title="Herunterladen"
                                    onclick="downloadDokument('@d.Dateiname', '@d.Id')">
                                <i class="bi bi-download"></i>
                            </button>
                            <button class="action-btn" title="Vorschau"
                                    onclick="previewDokument('@d.Dateiname', '@d.Id')">
                                <i class="bi bi-eye"></i>
                            </button>
                            <div class="btn-group" style="display:inline-block;">
                                <button class="action-btn dropdown-toggle" data-bs-toggle="dropdown" 
                                        aria-expanded="false" title="Teilen">
                                    <i class="bi bi-share"></i>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li>
                                        <a class="dropdown-item" href="#" onclick="shareEmail('@d.Dateiname')">
                                            <i class="bi bi-envelope"></i> Per E-Mail teilen
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item" href="#" onclick="shareLink('@d.Dateiname')">
                                            <i class="bi bi-link-45deg"></i> Link kopieren
                                        </a>
                                    </li>
                                </ul>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<!-- History Toggle Button -->
<button id="toggleHistoryBtn" onclick="toggleHistoryPanel()">
    <i class="bi bi-clock-history" style="margin-right:0.5em"></i> Verlauf
</button>

<!-- History Sidebar -->
<div id="searchHistoryPanel" class="collapsed">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom:1.5rem;">
        <h3 style="margin:0;">🔎 Suchverlauf</h3>
    </div>
    
    <div id="historyFilters" style="margin-bottom: 1.5rem;">
        <button class="btn active" data-filter="all" onclick="filterHistory(this)">Alle</button>
        <button class="btn" data-filter="today" onclick="filterHistory(this)">Heute</button>
        <button class="btn" data-filter="yesterday" onclick="filterHistory(this)">Gestern</button>
        <button class="btn" data-filter="week" onclick="filterHistory(this)">Letzte 7 Tage</button>
    </div>

    <div id="historyContent" style="flex: 1; display:flex; flex-direction:column; overflow:hidden;">
        <table class="modern-table" id="historyTable" style="margin-bottom:0;">
            <thead>
                <tr>
                    <th style="width: 38%;">Suchbegriff</th>
                    <th style="width: 28%;">Dateiname</th>
                    <th style="width: 24%;">Zeit</th>
                    <th style="width: 10%;">Aktion</th>
                </tr>
            </thead>
        </table>
        <div id="historyListWrapper" style="flex:1; overflow-y:auto;">
            <table class="modern-table" style="margin-bottom:0;">
                <tbody id="historyList"></tbody>
            </table>
        </div>
        <button class="modern-btn" style="margin-top:1.5rem; width:100%;" onclick="clearHistory()">
            Verlauf löschen
        </button>
    </div>
</div>

<!-- Email Modal -->
<div class="modal fade modern-modal" id="shareEmailModal" tabindex="-1">
    <div class="modal-dialog">
        <form id="shareEmailForm" class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-envelope-paper-heart"></i> Per E-Mail teilen
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="shareEmailDateiname" name="Dateiname" />
                <div class="mb-3">
                    <label for="empfaengerEmail" class="form-label">Empfänger E-Mail</label>
                    <input type="email" class="form-control" id="empfaengerEmail" 
                           name="Empfaenger" required placeholder="z.B. max@muster.de">
                </div>
                <div class="mb-3">
                    <label for="emailBetreff" class="form-label">Betreff</label>
                    <input type="text" class="form-control" id="emailBetreff" 
                           name="Betreff" value="Ihr Dokument" required>
                </div>
                <div class="mb-3">
                    <label for="emailNachricht" class="form-label">Nachricht</label>
                    <textarea class="form-control" id="emailNachricht" name="Nachricht" 
                              rows="3">Im Anhang finden Sie Ihr Dokument.</textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                <button type="submit" class="modern-btn">Senden</button>
            </div>
        </form>
    </div>
</div>

<!-- Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-body position-relative">
                <!-- 🔄 Loading Spinner -->
                <div id="searchPreviewSpinner" class="spinner-overlay d-none">
                    <div class="spinner-border text-primary spinner-border-lg" role="status"></div>
                    <p class="mt-3 text-muted fw-bold">Wird geladen...</p>
                </div>
                <iframe id="pdfFrame" style="width:100%;height:80vh;" frameborder="0"></iframe>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/awesomplete/1.1.5/awesomplete.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/awesomplete/1.1.5/awesomplete.min.js"></script>
    <script>
        // Mode Toggle
        function zeigeSuche(mode) {
            document.getElementById('intelligent').style.display = (mode === 'intelligent') ? 'block' : 'none';
            document.getElementById('index').style.display = (mode === 'index') ? 'block' : 'none';
            document.getElementById('btnIntelligent').classList.toggle('active', mode === 'intelligent');
            document.getElementById('btnIndex').classList.toggle('active', mode === 'index');
            if (document.getElementById('currentSearchMode'))
                document.getElementById('currentSearchMode').value = mode;
            if (document.getElementById('indexModeField'))
                document.getElementById('indexModeField').value = mode;
        }

        document.addEventListener("DOMContentLoaded", function () {
            let mode = "intelligent";
            const current = document.getElementById('currentSearchMode');
            const url = new URL(window.location.href);
            if (url.search.includes("Filter.")) mode = "index";
            else if (current && current.value === "index") mode = "index";
            zeigeSuche(mode);

            if (mode === "intelligent") initLiveSearch();
            else initIndexSearch();

            document.getElementById('searchHistoryPanel').classList.add('collapsed');
        });

        // Live Search & Autocomplete
        function initLiveSearch() {
            const input = document.getElementById("liveSearch");
            const loader = document.getElementById("loader");
            const tbody = document.getElementById("resultBody");
            if (!input || !tbody || !loader) return;

            rechercher("");

            const awesomplete = new Awesomplete(input, { minChars: 2, maxItems: 8, autoFirst: true });

            async function rechercher(query) {
                loader.style.display = 'block';
                fetch(`?handler=SearchLive&query=${encodeURIComponent(query)}`)
                    .then(res => res.json())
                    .then(data => {
                        tbody.innerHTML = data.map(d => `
                            <tr>
                                <td><strong>${d.dateiname}</strong></td>
                                <td>${new Date(d.hochgeladenAm).toLocaleString()}</td>
                                <td>${d.kategorie}</td>
                                <td style="text-align:right;">
                                    <button class="action-btn" title="Herunterladen"
                                        onclick="downloadDokument('${d.dateiname.replace(/'/g, "\\'")}', '${d.id || ''}')">
                                        <i class="bi bi-download"></i>
                                    </button>
                                    <button class="action-btn" title="Vorschau"
                                        onclick="previewDokument('${d.dateiname.replace(/'/g, "\\'")}', '${d.id || ''}')">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                    <div class="btn-group" style="display:inline-block;">
                                        <button class="action-btn dropdown-toggle"
                                            data-bs-toggle="dropdown" aria-expanded="false" title="Teilen">
                                            <i class="bi bi-share"></i>
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end">
                                            <li>
                                                <a class="dropdown-item" href="#" onclick="shareEmail('${d.dateiname.replace(/'/g, "\\'")}', '${d.id || ''}')">
                                                    <i class="bi bi-envelope"></i> Per E-Mail teilen
                                                </a>
                                            </li>
                                            <li>
                                                <a class="dropdown-item" href="#" onclick="shareLink('${d.dateiname.replace(/'/g, "\\'")}', '${d.id || ''}')">
                                                    <i class="bi bi-link-45deg"></i> Link kopieren
                                                </a>
                                            </li>
                                        </ul>
                                    </div>
                                </td>
                            </tr>
                        `).join('');

                        document.querySelectorAll('#resultBody .dropdown-toggle').forEach(function (el) {
                            new bootstrap.Dropdown(el);
                        });

                        if (query && query.length > 1) saveSearchHistory(query);
                    })
                    .catch(err => console.error("❌ Fehler bei Suche:", err))
                    .finally(() => loader.style.display = 'none');
            }

            input.addEventListener("input", function () {
                const q = input.value.trim();
                if (q.length < 2) {
                    if (q === "") rechercher("");
                    return;
                }
                fetch(`?handler=Suggest&term=${encodeURIComponent(q)}`)
                    .then(res => res.json())
                    .then(data => { awesomplete.list = data; });
            });

            input.addEventListener("awesomplete-selectcomplete", function () {
                const selected = input.value.trim();
                if (selected) rechercher(selected);
            });
        }

        // Index Search
        function initIndexSearch() {
            const form = document.querySelector("#index form");
            if (!form) return;
            form.addEventListener("submit", function (e) {
                const fields = Array.from(form.querySelectorAll("input[type=text]"));
                const filled = fields.filter(i => i.value && i.value.trim().length > 0);
                if (filled.length === 0) return;

                let term = filled.map(f =>
                    (f.previousElementSibling ? f.previousElementSibling.textContent.trim() + ": " : "") + f.value.trim()
                ).join(" | ");
                saveSearchHistory(term);
            });
        }

        // History Functions
        let allHistoryItems = [];

        async function loadHistory(filter = "all") {
            const resp = await fetch('/api/SearchHistory/GetAll');
            let items = await resp.json();
            allHistoryItems = items;

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            items = items.filter(entry => {
                const d = new Date(entry.searchedAt);
                d.setHours(0, 0, 0, 0);
                if (filter === "today") return isSameDay(today, d);
                if (filter === "yesterday") return isYesterday(d);
                if (filter === "week") return isThisWeek(d);
                return true;
            });

            const tbody = document.getElementById('historyList');
            tbody.innerHTML = '';
            if (!items.length) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#999;">Kein Verlauf gefunden.</td></tr>';
                return;
            }
            items.forEach(entry => {
                tbody.innerHTML += `
                    <tr style="cursor:pointer"
                        onclick="fillSearchFromHistory('${entry.searchTerm.replace(/'/g, "\\'")}')">
                        <td title="${entry.searchTerm}">
                            ${entry.searchTerm && entry.searchTerm.length > 50
                        ? entry.searchTerm.substring(0, 50) + '…'
                        : entry.searchTerm || ''}
                        </td>
                        <td title="${entry.dokumentName || ''}">
                            ${entry.dokumentName
                        ? `<a href="/api/DokumentIndex/Download?file=${encodeURIComponent(entry.dokumentName)}" target="_blank">${entry.dokumentName.length > 30 ? entry.dokumentName.substring(0, 27) + '…' : entry.dokumentName}</a>`
                        : '-'}
                        </td>
                        <td>
                            ${new Date(entry.searchedAt).toLocaleString()}
                        </td>
                        <td>
                            <button class="action-btn" onclick="event.stopPropagation(); deleteHistoryEntry(${entry.id})">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>`;
            });
        }

        function filterHistory(btn) {
            document.querySelectorAll("#historyFilters .btn").forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            loadHistory(btn.getAttribute("data-filter"));
        }

        document.addEventListener("DOMContentLoaded", function () {
            loadHistory();
        });

        function fillSearchFromHistory(searchTerm) {
            const input = document.getElementById('liveSearch');
            if (input) {
                input.value = searchTerm;
                input.focus();
                input.dispatchEvent(new Event('input'));
            }
        }
        window.fillSearchFromHistory = fillSearchFromHistory;

        async function saveSearchHistory(term, dokumentId = null) {
            if (!term || term.length < 2) return;
            await fetch('/api/SearchHistory/Add', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ searchTerm: term, dokumentId: dokumentId })
            });
        }

        async function clearHistory() {
            if (confirm('Verlauf wirklich löschen?')) {
                await fetch('/api/SearchHistory/ClearAll', { method: 'POST' });
                loadHistory();
            }
        }

        async function deleteHistoryEntry(id) {
            await fetch(`/api/SearchHistory/Delete/${id}`, { method: 'DELETE' });
            loadHistory();
        }

        function toggleHistoryPanel() {
            const panel = document.getElementById('searchHistoryPanel');
            panel.classList.toggle('collapsed');
            if (!panel.classList.contains('collapsed')) {
                loadHistory();
            }
        }

        // Document Actions
        function downloadDokument(dateiname, dokumentId) {
            saveSearchHistory("Download: " + dateiname, dokumentId);
            window.open(`/api/DokumentIndex/Download?file=${encodeURIComponent(dateiname)}`, '_blank');
        }

        let previewModalInstance = null;
        function previewDokument(dateiname, dokumentId) {
            saveSearchHistory("Vorschau: " + dateiname, dokumentId);
            var url = `/api/DokumentIndex/Download?file=${encodeURIComponent(dateiname)}`;
            
            const frame = document.getElementById('pdfFrame');
            const spinner = document.getElementById('searchPreviewSpinner');

            // 🔄 Spinner logic
            if(spinner) {
                spinner.classList.remove("d-none");
                frame.classList.add("d-none");

                frame.onload = () => {
                    spinner.classList.add("d-none");
                    frame.classList.remove("d-none");
                };

                // Fallback Timer
                setTimeout(() => {
                    if(!spinner.classList.contains("d-none")){
                         spinner.classList.add("d-none");
                         frame.classList.remove("d-none");
                    }
                }, 15000);
            }

            frame.src = url;
            
            if (!previewModalInstance) {
                previewModalInstance = new bootstrap.Modal(document.getElementById('previewModal'));
            }
            previewModalInstance.show();
        }

        function shareLink(dateiname) {
            const link = `${window.location.origin}/Dokument/Download?file=${encodeURIComponent(dateiname)}`;
            navigator.clipboard.writeText(link)
                .then(() => alert("Link kopiert!"))
                .catch(() => alert("Konnte Link nicht kopieren"));
        }

        function shareEmail(dateiname) {
            document.getElementById('shareEmailDateiname').value = dateiname;
            document.getElementById('empfaengerEmail').value = '';
            var myModal = new bootstrap.Modal(document.getElementById('shareEmailModal'));
            myModal.show();
        }

        document.getElementById('shareEmailForm').addEventListener('submit', async function (e) {
            e.preventDefault();
            const dateiname = document.getElementById('shareEmailDateiname').value;
            const empfaenger = document.getElementById('empfaengerEmail').value;
            const betreff = document.getElementById('emailBetreff').value;
            const nachricht = document.getElementById('emailNachricht').value;
            const response = await fetch('/api/DokumentIndex', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ Dateiname: dateiname, Empfaenger: empfaenger, Betreff: betreff, Nachricht: nachricht })
            });
            if (response.ok) {
                alert("E-Mail wurde erfolgreich gesendet!");
                bootstrap.Modal.getInstance(document.getElementById('shareEmailModal')).hide();
            } else {
                alert("Fehler beim Senden der E-Mail!");
            }
        });

        // Close panel on outside click
        document.addEventListener('mousedown', function (event) {
            var panel = document.getElementById('searchHistoryPanel');
            var toggleBtn = document.getElementById('toggleHistoryBtn');
            if (!panel.classList.contains('collapsed')) {
                if (!panel.contains(event.target) && event.target !== toggleBtn) {
                    panel.classList.add('collapsed');
                }
            }
        });

        document.addEventListener('keydown', function (event) {
            if (event.key === "Escape") {
                var panel = document.getElementById('searchHistoryPanel');
                if (!panel.classList.contains('collapsed')) {
                    panel.classList.add('collapsed');
                }
            }
        });

        // Date helpers
        function isSameDay(d1, d2) {
            return d1.getFullYear() === d2.getFullYear() &&
                d1.getMonth() === d2.getMonth() &&
                d1.getDate() === d2.getDate();
        }

        function isYesterday(date) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const yesterday = new Date(today);
            yesterday.setDate(today.getDate() - 1);

            date = new Date(date);
            date.setHours(0, 0, 0, 0);

            return date.getTime() === yesterday.getTime();
        }

        function isThisWeek(date) {
            const now = new Date();
            now.setHours(0, 0, 0, 0);
            const weekAgo = new Date(now);
            weekAgo.setDate(now.getDate() - 6);

            date = new Date(date);
            date.setHours(0, 0, 0, 0);

            return date >= weekAgo && date <= now;
        }

        // Global exports
        window.downloadDokument = downloadDokument;
        window.previewDokument = previewDokument;
        window.shareLink = shareLink;
        window.shareEmail = shareEmail;
        window.toggleHistoryPanel = toggleHistoryPanel;
        window.clearHistory = clearHistory;
        window.deleteHistoryEntry = deleteHistoryEntry;
    </script>
}
