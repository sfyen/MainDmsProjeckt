@page
@model DmsProjeckt.Pages.Dokument.AdminVerwaltungModel
@{
    ViewData["Title"] = "Benutzerrollen verwalten";
}

<div class="modern-admin-wrapper">
    <div class="admin-header">
        <h2>👤 Benutzerrollen verwalten</h2>
        <p>Verwalte Benutzerkonten und Berechtigungen</p>
    </div>

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert-modern alert-success">
            ✅ @TempData["SuccessMessage"]
        </div>
    }

    <div class="d-flex justify-content-end mb-4">
        <button type="button" class="btn-modern-primary" data-bs-toggle="modal" data-bs-target="#createUserModal">
            ➕ Neuen Benutzer erstellen
        </button>
    </div>

    <div class="table-responsive">
        <table class="modern-admin-table">
            <thead>
                <tr>
                    <th>Benutzername</th>
                    <th>Aktuelle Rolle</th>
                    <th>Rolle ändern</th>
                    <th>Aktion</th>
                </tr>
            </thead>
            <tbody>
            @foreach (var user in Model.Users)
            {
                <tr>
                    <td><strong>@user.UserName</strong></td>
                    <td>
                        @if (user.CurrentRole == "Admin")
                        {
                            <span class="role-badge role-admin">🛡️ @user.CurrentRole</span>
                        }
                        else if (user.CurrentRole == "Editor")
                        {
                            <span class="role-badge role-editor">🖋️ @user.CurrentRole</span>
                        }
                        else if (user.CurrentRole == "Viewer")
                        {
                            <span class="role-badge role-viewer">👀 @user.CurrentRole</span>
                        }
                        else
                        {
                            <span class="role-badge role-default">@user.CurrentRole</span>
                        }
                    </td>
                    <td>
                        <form method="post" class="role-form">
                            <input type="hidden" name="UserId" value="@user.UserId" />
                            <select name="SelectedRole" class="modern-select">
                                @foreach (var role in user.AvailableRoles)
                                {
                                    var selected = role == user.CurrentRole ? "selected=\"selected\"" : "";
                                    @:<option value="@role" @Html.Raw(selected)>@role</option>
                                }
                            </select>
                            <button type="submit" class="btn-modern-small">🔄 Aktualisieren</button>
                        </form>
                    </td>
                </tr>
            }
            </tbody>
        </table>
    </div>

    <!-- Audit Log Section -->
    <div class="audit-section">
        <h3>📝 Admin-Aktivitätsprotokoll</h3>
        <div class="table-responsive">
            <table class="modern-admin-table">
                <thead>
                    <tr>
                        <th>Zeitpunkt</th>
                        <th>Aktion</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model.Logs != null && Model.Logs.Any())
                    {
                        foreach (var log in Model.Logs)
                        {
                            <tr>
                                <td><span class="timestamp">@log.Timestamp.ToString("g")</span></td>
                                <td>@log.Action</td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="2" class="empty-state">Keine protokollierten Aktivitäten vorhanden.</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Create User Modal -->
<div class="modal fade" id="createUserModal" tabindex="-1" aria-labelledby="createUserModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content modern-modal">
            <div class="modal-header">
                <h5 class="modal-title" id="createUserModalLabel">➕ Neuen Benutzer anlegen</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" asp-page-handler="CreateUser">
                <div class="modal-body">
                    <div class="form-group">
                        <label for="Username">Benutzername</label>
                        <input type="text" class="form-control" name="Username" required />
                    </div>
                    <div class="form-group">
                        <label for="Email">E-Mail</label>
                        <input type="email" class="form-control" name="Email" required />
                    </div>
                    <div class="form-group">
                        <label for="Password">Passwort</label>
                        <input type="password" class="form-control" name="Password" required />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn-modern-primary" data-bs-target="#assignRoleModal" data-bs-toggle="modal" data-bs-dismiss="modal">
                        Weiter ➡️
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Assign Role Modal -->
<div class="modal fade" id="assignRoleModal" tabindex="-1" aria-labelledby="assignRoleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content modern-modal">
            <div class="modal-header">
                <h5 class="modal-title" id="assignRoleModalLabel">🔐 Rolle & Berechtigungen</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" asp-page-handler="AssignRole">
                <div class="modal-body">
                    <input type="hidden" name="UserId" id="createdUserId" />
                    <div class="form-group">
                        <label>Rolle wählen</label>
                        <select class="modern-select" name="Role">
                            <option value="Admin">Admin</option>
                            <option value="Editor">Editor</option>
                            <option value="Viewer">Viewer</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Optionale Ordnerrechte</label>
                        <div class="permission-checkboxes">
                            <label class="checkbox-label">
                                <input type="checkbox" name="Permissions" value="/ordnerA:read" />
                                Ordner A lesen
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="Permissions" value="/ordnerA:write" />
                                Ordner A schreiben
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn-modern-success">Benutzer erstellen ✅</button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
    /* Modern Admin Wrapper */
    .modern-admin-wrapper {
        background: white;
        border-radius: 1.1rem;
        box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        padding: 2.5rem 2rem;
        margin: 2rem 0;
    }

    /* Modern Header */
    .admin-header {
        text-align: center;
        margin-bottom: 3rem;
        padding-bottom: 2rem;
        border-bottom: 1px solid #f0f0f0;
    }

    .admin-header h2 {
        color: #000;
        font-size: 2rem;
        margin-bottom: 0.5rem;
        font-weight: 600;
    }

    .admin-header p {
        color: #666;
        font-size: 1rem;
        margin: 0;
    }

    /* Modern Alert */
    .alert-modern {
        padding: 1rem 1.5rem;
        border-radius: 0.6rem;
        margin-bottom: 1.5rem;
        font-weight: 600;
    }

    .alert-success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    /* Modern Table Container */
    .table-responsive {
        border-radius: 0.8rem;
        overflow: hidden;
        border: 1px solid #e0e0e0;
    }

    /* Modern Table */
    .modern-admin-table {
        width: 100%;
        border-collapse: collapse;
        background-color: white;
        color: #333;
        margin: 0;
    }

    .modern-admin-table thead {
        background: linear-gradient(to bottom, #fafafa, #f5f5f5);
    }

    .modern-admin-table th {
        color: #000;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.85rem;
        letter-spacing: 0.5px;
        padding: 1.2rem 1.5rem;
        border-bottom: 2px solid #e0e0e0;
        text-align: left;
    }

    .modern-admin-table td {
        padding: 1rem 1.5rem;
        border-bottom: 1px solid #f5f5f5;
        vertical-align: middle;
        color: #333;
    }

    .modern-admin-table tbody tr {
        transition: all 0.2s;
        background-color: white;
    }

    .modern-admin-table tbody tr:nth-child(even) {
        background-color: #fafafa;
    }

    .modern-admin-table tbody tr:hover {
        background-color: #f0f4f8;
        transform: scale(1.001);
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    /* Role Badges */
    .role-badge {
        display: inline-block;
        padding: 0.4rem 0.9rem;
        border-radius: 1rem;
        font-size: 0.85rem;
        font-weight: 600;
        white-space: nowrap;
    }

    .role-admin {
        background: #fce4ec;
        color: #c62828;
        border: 1px solid #f8bbd9;
    }

    .role-editor {
        background: #fff3e0;
        color: #e65100;
        border: 1px solid #ffcc80;
    }

    .role-viewer {
        background: #e8f5e9;
        color: #2e7d32;
        border: 1px solid #a5d6a7;
    }

    .role-default {
        background: #f5f5f5;
        color: #666;
        border: 1px solid #e0e0e0;
    }

    /* Modern Buttons */
    .btn-modern-primary {
        background: #000;
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 0.5rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-modern-primary:hover {
        background: #333;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }

    .btn-modern-small {
        background: #000;
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 0.4rem;
        font-size: 0.85rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        margin-top: 0.5rem;
    }

    .btn-modern-small:hover {
        background: #333;
        transform: translateY(-1px);
    }

    .btn-modern-success {
        background: #28a745;
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 0.5rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-modern-success:hover {
        background: #218838;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(40,167,69,0.3);
    }

    /* Modern Select */
    .modern-select {
        background: white;
        color: #000;
        border: 1.5px solid #e0e0e0;
        padding: 0.6rem 1rem;
        border-radius: 0.5rem;
        font-size: 0.95rem;
        transition: all 0.2s;
        width: 100%;
        max-width: 200px;
    }

    .modern-select:focus {
        border-color: #000;
        outline: none;
        box-shadow: 0 0 0 3px rgba(0,0,0,0.1);
    }

    /* Role Form */
    .role-form {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    /* Audit Section */
    .audit-section {
        margin-top: 3rem;
        padding-top: 2rem;
        border-top: 1px solid #f0f0f0;
    }

    .audit-section h3 {
        color: #000;
        font-size: 1.3rem;
        font-weight: 600;
        margin-bottom: 1.5rem;
    }

    .timestamp {
        color: #3b82f6;
        font-weight: 600;
    }

    .empty-state {
        text-align: center;
        color: #999;
        padding: 2rem 1rem;
        font-style: italic;
    }

    /* Modern Modal */
    .modern-modal {
        background: white;
        border-radius: 1rem;
        border: 1px solid #e0e0e0;
    }

    .modern-modal .modal-header {
        border-bottom: 1px solid #f0f0f0;
        padding: 1.5rem 2rem;
    }

    .modern-modal .modal-title {
        color: #000;
        font-weight: 700;
        font-size: 1.3rem;
    }

    .modern-modal .modal-body {
        padding: 2rem;
    }

    .modern-modal .modal-footer {
        border-top: 1px solid #f0f0f0;
        padding: 1.25rem 2rem;
        background: #f9f9f9;
    }

    .modern-modal .form-group {
        margin-bottom: 1.25rem;
    }

    .modern-modal .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: #000;
    }

    .modern-modal .form-control {
        background: #f8f9fa;
        color: #000;
        border: 2px solid #e0e0e0;
        border-radius: 0.6rem;
        padding: 0.75rem 1rem;
        transition: all 0.2s;
    }

    .modern-modal .form-control:focus {
        border-color: #000;
        background: white;
        box-shadow: 0 0 0 4px rgba(0,0,0,0.08);
        outline: none;
    }

    /* Permission Checkboxes */
    .permission-checkboxes {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .checkbox-label {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        cursor: pointer;
        font-weight: 500;
        color: #333;
    }

    .checkbox-label input[type="checkbox"] {
        width: 1.1rem;
        height: 1.1rem;
        cursor: pointer;
    }
</style>

<script>
    setTimeout(function () {
        const alertBox = document.querySelector('.alert-modern');
        if (alertBox) {
            alertBox.style.display = 'none';
        }
    }, 3000);
</script>
